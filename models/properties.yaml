version: 2

sources:
  - name: "scooters_raw"
    description: "Raw data provided by scooters service"
    loader: "custom loader from github.com"
    tables:
      - name: "trips"
        description: "Scooter trips"

      - name: "users"
        description: "Users of scooter service"

      - name: "events"
        description: "Raw user events with duplicates"

models:
  - name: "trips_prep"
    description: "Trips prepared for analysis"
    config:
      materialized: "view"
  - name: "trips_stat"
    description: "Trips statistics"
  - name: "trips_stat_daily"
    description: "Trips daily statistics"
    indexes:
      - columns: ["date"]
        unique: true
  - name: "trips_age_daily"
    description: "Trips age daily statistics"
  - name: "trips_age_daily_stat"
    description: "Trips age statistics"

  - name: "trips_geom"
    description: "Trips geometric view"
    config:
      materialized: "view"
  - name: "parking_start_stat"
    description: "Parking start statistics by 500m hexagons"
  - name: "parking_finish_stat"
    description: "Parking finish statistics by 10m hexagons"

  - name: "trips_users"
    description: "Trips joined with users"
    config:
      materialized: "incremental"
      post-hook:
        - "analyze dbt.trips_users"
        - sql: "vacuum dbt.trips_users"
          transaction: false

  - name: "events_clean"
    description: "Deduplicated events"
    config:
      materialized: "incremental"
      strategy: "merge"
      unique_key: [ "user_id", "timestamp", "type_id" ]

  - name: "events_full"
    description: "Deduplicated events with types"
    config:
      materialized: "view"

  - name: "events_stat"
    description: "Events cancellation statistics"

  - name: "trips_concurrency"
    description: "Trips concurrency"
    config:
      materialized: "incremental"

  - name: "companies"
    description: "Manufacturers statistics"

  - name: "companies_trips"
    description: "Manufacturers trips statistics"

  - name: "trips_age_group"
    description: "Trips age groups statistics"
